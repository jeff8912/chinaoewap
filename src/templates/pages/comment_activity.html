<ion-view hide-back-button="false" id="comment_activity">
	<ion-nav-buttons side="right">
		<a class="button button-blue btnsubmit" ng-href="" ng-if="isEdit" ng-click="submitComment()">提交</a>
	</ion-nav-buttons>
	<ion-nav-title align-title="center">
		<!--活动评论-->
		<span class="ui inverted header">发表评论</span>
	</ion-nav-title>
	<ion-content overflow-scroll="false" has-bouncing="true">
		<div class="list">
			<div class="item">
				<p class="activity_title">{{postModel.abiName}}</p>
				<span>主办单位： {{postModel.abiSponsor}}</span><br />
				<span>时间： {{postModel | dateregion}}</span><br />
				<span>活动地点：{{postModel.abiGpsPlace}}</span>
			</div>
		</div>
		<div class="item item-image" style="padding: 1rem; border: 0;">
			<div class="full-image" ng-repeat="file in postModel.imgUrl">
				<img ng-src="{{file | formatDbImgUrl}}" />
			</div>
		</div>
		<div class="list no-margin-bottom">
			<div class="item item-encourage" ng-if="isEdit">为此次活动打分鼓励一下吧</div>
		</div>
		<!--<hr ng-if="isEdit" />-->
		<div class="rating-div">
			<div class="ui rating" data-rating="0" data-max-rating="5"></div>
		</div>
		<div class="commentDiv item-textarea" ng-if="isEdit">
			<textarea id="comment" rows="5" placeholder="写点评价，您的意见对其他同学很有帮助哦~" ng-model="postModel.aciContent" maxlength="150" autocomplete="off" autocorrect="off"></textarea>
			<p class="float-right textarea-sub">{{postModel.aciContent.length || 0}}/150</p>
		</div>
	</ion-content>
</ion-view>
<script type="text/javascript">
	function pageCtrl($scope, $http, $rootScope, $ionicHistory, $timeout, $ionicModal, $ionicPopup, EventBus, $ionicPopover, Upload, $ionicLoading) {
		var id = $scope.pageParams().id;
		$scope.model = {
			comment: {}
		};
		$scope.postModel = {
			aciScore: 0
		};
		$scope.getexpense = function() {
			ajaxPost.call(
				$scope, $http,
				API_appserverurl + '/api/activitybaseinfo/getModel', {
					id: id
				},
				'获取活动评论信息',
				function(data) {
					$scope.model.comment = data;
					$scope.postModel.abiId = data.id;
					$scope.postModel.abiName = data.abiName;
					$scope.postModel.abiStartTime = data.abiStartTime;
					$scope.postModel.abiEndTime = data.abiEndTime;
					$scope.postModel.abiSponsor = data.abiSponsor;
					$scope.postModel.abiGpsPlace = data.abiGpsPlace;
					$scope.postModel.imgUrl = data.imgUrl;
					 $scope.postModel.auditStatus = 0;
					if(data.commentAudit == 0) { // 审核=是否需要审核 评论是否审核，0为不审核（默认），1位审核
						$scope.postModel.auditStatus =2;
					}
					if(data.allowComment == 2) { // 是否允许评论，0为允许,公开评论（默认），1为允许,参与活动人员评论，2为不允许'
						$scope.$parent.isEdit = false;
					} else {
						$scope.$parent.isEdit = true;
					}
				},
				function(error) {
					//TODO
				});
		}
		$scope.getexpense();

		$('.ui.rating')
			.rating({
				initialRating: 3,
				maxRating: 5
			});
		//提交评论
		$scope.submitComment = function() {
				//console.log(JSON.stringify($scope.postModel) + " =======提交数据========");
				$scope.postModel.aciScore = $(".ui.rating").find(".active.icon").length;
				if($scope.postModel.aciScore <= 0) {
					showError("请给话动评分");
					return;
				}
				if(!$scope.postModel.aciContent) {
					showError("请给本次活动一点意见");
					return;
				}
				if($scope.postModel.aciContent.length > 100) {
					showError("文字过多");
					return;
				}
				$scope.postModel.pid = 0;
				$scope.postModel.path = "0,";
				ajaxPost.call(
					$scope, $http,
					API_appserverurl + '/api/activitycommentinfo/addData',
					$scope.postModel,
					'活动评论提交',
					function(data) {
						console.log("成功！");
						$scope.showSubmitSuccess();
					},
					function(error) {
						console.log("失败！" + error);
					});
			}
			//提交成功
		var commentPopup = null;
		$scope.showSubmitSuccess = function() {
				commentPopup = $ionicPopup.show({
					title: '<div style="position: relative;"><i style="top:0; right: 0;" class="icon-common_prompt_cancel"></i><div>',
					template: '<i ng-click="closeCommentPopup()" class="icon-common_prompt_cancel"></i>' +
						'<div class="submit-success-div">' +
						'<span class="icon-my_comment_success">' +
						'<span class="path1"></span><span class="path2"></span><span class="path3"></span><span class="path4"></span>' +
						'<span class="path5"></span><span class="path6"></span><span class="path7"></span><span class="path8"></span>' +
						'<span class="path9"></span><span class="path10"></span><span class="path11"></span><span class="path12"></span>' +
						'<span class="path13"></span><span class="path14"></span><span class="path15"></span><span class="path16"></span>' +
						'<span class="path17"></span><span class="path18"></span><span class="path19"></span><span class="path20"></span>' +
						'<span class="path21"></span><span class="path22"></span><span class="path23"></span><span class="path24"></span>' +
						'<span class="path25"></span><span class="path26"></span><span class="path27"></span><span class="path28"></span>' +
						'<span class="path29"></span><span class="path30"></span><span class="path31"></span><span class="path32"></span>' +
						'<span class="path33"></span><span class="path34"></span><span class="path35"></span><span class="path36"></span>' +
						'<span class="path37"></span><span class="path38"></span><span class="path39"></span>' +
						'</span><br/><div class="desc">评论成功</div><div>',
					//				template: '<div style="text-align: center;">成功评论<div>',
					scope: $scope,
					buttons: [{
						text: '查看此评分',
						type: 'button-positive',
						onTap: function(e) {
							$scope.postModel = {
								aeiImgUrl: [],
								auditStatus: 0,
								aeiAmount: 0,
								amount: 0
							};
							$scope.openWindow('activity_details', {
								id: id
							});
							commentPopup.close();
						}
					}, {
						text: '返回',
						type: 'button-positive',
						onTap: function(e) {
							$scope.postModel = {
								aeiImgUrl: [],
								auditStatus: 0,
								aeiAmount: 0,
								amount: 0
							};
							$scope.openWindow('activity_details', { // 后继优化 利用评分人Id 及活动Id comment_activity_info 查询
								id: id
							});
							commentPopup.close();
						}
					}]
				});
			}
			//关闭弹出框
		$scope.closeCommentPopup = function() {
			commentPopup.close();
		}
	}
</script>