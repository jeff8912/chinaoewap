<style>
  .noAfter:after {
    background: transparent !important;
  }
</style>
<ion-view view-title="新增活动" id="add_activity">
  <ion-nav-buttons side="right">
    <a tabindex="0" class="button button-blue btnsubmit" ng-href="" ng-click="createActivity()" autofocus="autofocus">提交</a>
  </ion-nav-buttons>
  <ion-content overflow-scroll="false" has-bouncing="true" class="has-header">
    <form>
      <div class="list marginBottom marginTop">
        <label class="item item-input">
          <span class="input-label">活动类别</span>
          <input tabindex="1" type="text" placeholder="请添加活动类别" ng-click="openWindow('activity_category')"
                 ng-model="model.abiCategory">
        </label>
        <label class="item item-input">
          <span class="input-label">活动名称</span>
          <input tabindex="2" type="text" placeholder="请输入活动名称" ng-model="model.abiName">
        </label>
        <label class="item item-input">
          <span class="input-label">活动主办方</span>
          <input tabindex="3" type="text" placeholder="请添加活动主办方" ng-click="openWindow('activity_sponsor')"
                 ng-model="model.abiSponsor" readonly="readonly" style="background-color:#fff;">
        </label>
        <label class="item item-input">
          <span class="input-label">活动承办方</span>
          <input tabindex="4" type="text" placeholder="请添加活动承办方" ng-click="openWindow('activity_organizer')"
                 ng-model="model.abiOrganizer" readonly="readonly" style="background-color:#fff;">
        </label>
      </div>
      <div class="list marginBottom">
        <label class="item item-stacked-label item-input noAfter item-textarea">
          <span class="input-label">活动意义</span>
          <textarea tabindex="5" placeholder="填写活动意义" rows="10" ng-model="model.abiPurpose" maxlength="2500" autocomplete="off" autocorrect="off"></textarea>
          <span class="words">{{model.abiPurpose.length || 0}}/2500</span>
        </label>
        <label class="item item-stacked-label item-input item-textarea">
          <span class="input-label">活动简介</span>
          <textarea tabindex="6" placeholder="填写活动简介" rows="10" ng-model="model.abiDescription" maxlength="2500" autocomplete="off" autocorrect="off"></textarea>
          <span class="words">{{model.abiDescription.length || 0}}/2500</span>
        </label>
      </div>
      <div class="list marginBottom">
      	<div class="item item-input upload-label no-thin-border no-margin-bottom">
					<span class="input-label">首页轮播图片（仅一张,建议尺寸720X430）</span>
				</div>
        <div class="item item-input marginTop marginBottom multiple-label row">
          <div class="multiple-div col-33"  ng-if="model.bannerUrl">
          	<div class="img-span">
	            <img ng-src="{{model.bannerUrl | formatDbImgUrl}}"/>
	            <span class="icon-common_prompt_cancel" ng-click="deleteBannerImg()" ng-if="model.bannerUrl"></span>
	          </div>
          </div>
          <div class="multiple-div col-33" ng-if="!model.bannerUrl">
            <span class="icon-create_add_photo" style="font-size: 75px;color: #999999;"
                  ngf-change="uploadBannerFiles($file, $newFiles, $duplicateFiles, $invalidFiles, $event)"
                  ngf-accept="'image/*'" ngf-fix-orientation="true"
                  ngf-capture="'camera'" ngf-drop ngf-select ngf-resize="{width: 720, quality: 0.8, type: 'image/jpeg'}"
                  ngf-resize-if="$width > 720 || $height > 430"
                  ngf-validate="{height: {min: 430}, width: {min: 720}}"
                  ><span class="path1"></span><span
              class="path2"></span><span class="path3"></span></span>
          </div>
        </div>
      </div>
      <div class="list marginBottom">
      	<div class="item item-input upload-label no-thin-border no-margin-bottom">
					<span class="input-label">上传活动图片（无限制,建议尺寸680X360）</span>
				</div>
        <div class="item item-input marginTop marginBottom multiple-label row">
          <div class="multiple-div col-33" ng-repeat="file in model.imgUrl">
          	<div class="img-span">
	            <img ng-src="{{file | formatDbImgUrl}}"/>
	            <span class="icon-common_prompt_cancel" ng-click="deleteImg($index)"></span>
	          </div>
          </div>
          <div class="multiple-div col-33">
            <span class="icon-create_add_photo" style="font-size: 75px;color: #999999;" ngf-multiple="true"
                  ngf-change="uploadFiles($files,$newFiles, $duplicateFiles, $invalidFiles, $event)"
                  ngf-accept="'image/*'" ngf-fix-orientation="true"
                  ngf-capture="'camera'" ngf-drop ngf-select ngf-resize="{width: 680, quality: 0.8, type: 'image/jpeg'}"
                  ngf-resize-if="$width > 680 || $height > 360"
                  ngf-validate="{height: {min: 360}, width: {min: 680}}"
                  ><span class="path1"></span><span
              class="path2"></span><span class="path3"></span></span>
          </div>
        </div>
      </div>
      <div class="list marginBottom">
        <label class="item item-input marginBottom">
          <span class="remarks">如需上传活动策划书及其他附件，通过PC端上传！</span>
        </label>
      </div>
      <div class="list marginBottom">
        <label class="item item-input">
          <span class="input-label">开始时间</span>
          <input tabindex="7" type="datetime-local" ng-model="model.abiStartTime" placeholder="请选择活动开始时间">
        </label>
        <label class="item item-input">
          <span class="input-label">结束时间</span>
          <input tabindex="8" type="datetime-local" ng-model="model.abiEndTime" placeholder="请选择活动结束时间">
        </label>
        <label class="item item-input">
          <span class="input-label">报名截止</span>
          <input tabindex="9" type="datetime-local" ng-model="model.abiRegistrationDeadline" placeholder="请选择活动报名截止时间">
        </label>
        <div class="item item-input item-icon-right">
          <span class="input-label">活动地点</span>
          <input tabindex="10" type="text" placeholder="请添加活动地点" ng-model="model.abiGpsPlace" style="padding-right: 45px;">
          <i class="icon" ng-click="toMap()"><span class="icon-home_add mail"></span></i>
        </div>
        <div class="item item-input item-icon-right">
          <span class="input-label">组织人员</span>
          <input tabindex="11" type="text" placeholder="请添加组织人员名单" ng-click="openWindow('activity_organiser')"
                 ng-model="model.userName">
          <span class="mail icon-create_activity_mail_list" ng-click="openWindow('activity_organiser')"></span>
        </div>
        <label class="item item-input">
          <span class="input-label">报名人数</span>
          <input tabindex="12" type="number" placeholder="请填写报名人数" ng-model="model.limitSignNum">
        </label>
      </div>
      <div class="list marginBottom">
        <label class="item item-input">
          <span class="input-label">预算金额</span>
          <input tabindex="13" type="number" placeholder="请输入金额，不填写即不申报" ng-model="model.budget">
        </label>
      </div>
    </form>
  </ion-content>
</ion-view>

<script type="text/javascript">
var imgLength=0;
  function pageCtrl($scope, $http, $rootScope, $ionicHistory, $timeout, $ionicModal, $ionicPopup, EventBus, $ionicPopover, Upload, $ionicLoading) {

    $scope.model = {
      abiCategory: "",
      abiSponsor: "",
      abiOrganizer: "",
      userName: "",
      imgUrl: [],
      abiGpsPlace: "",
      abiWeightDate: "",
      auditTime: "",
      budget: "",
      allowComment: 0,//默认公开评论
      abiSignOpen: 0,//默认公开报名
      abiGpsLng: "",
      abiGpsLat: ""
    }

    EventBus.on('page.initApp', function (evt) {
    	  $timeout(function () {
    	  	$('button.back-button').focus();
    	  },10);
    });

    //监听选择 活动类别
    EventBus.on("notice.activity_category.onSubmit", function (evt) {

      if ($scope.$parent) {
        $scope.model.abiCategory = "";
        $scope.model.categoryId = evt.data;

        angular.forEach(evt.data, function (item) {
          $scope.model.abiCategory += item.sdiName + ","
        });

        $scope.model.abiCategory = $scope.model.abiCategory.substring(0, $scope.model.abiCategory.length - 1);
        printLog("监听选择活动类别" + JSON.stringify($scope.model.categoryId));
      }
    });

    //监听选择 活动主办方
    EventBus.on("notice.activity_sponsor.onSubmit", function (evt) {
      if ($scope.$parent) {
        $scope.model.abiSponsor = "";
        $scope.model.sponsorId = evt.data;

        angular.forEach(evt.data, function (item) {
          $scope.model.abiSponsor += item.sdiName + ","
        });

        $scope.model.abiSponsor = $scope.model.abiSponsor.substring(0, $scope.model.abiSponsor.length - 1);
        printLog("监听选择主办方" + JSON.stringify($scope.model.sponsorId));
      }

    });

    //监听选择 活动承办方
    EventBus.on("notice.activity_organizer.onSubmit", function (evt) {
      if ($scope.$parent) {
        $scope.model.abiOrganizer = "";
        $scope.model.organizerId = evt.data;

        angular.forEach(evt.data, function (item) {
          $scope.model.abiOrganizer += item.sdiName + ","
        });

        $scope.model.abiOrganizer = $scope.model.abiOrganizer.substring(0, $scope.model.abiOrganizer.length - 1);
        printLog("监听选择承办方" + JSON.stringify($scope.model.organizerId));
      }

    });

    //监听选择 活动地点
    EventBus.on("notice.baidumap.setPointPublish", function (evt) {
      if ($scope.$parent) {
        $scope.gps = evt.data;
        if($scope.model.abiGpsPlace == ""){
			$scope.model.abiGpsPlace = $scope.gps.Geo;
        }

        $scope.model.abiGpsLng = $scope.gps.Lng;
        $scope.model.abiGpsLat = $scope.gps.Lat;

        printLog("监听选择地点" + JSON.stringify($scope.gps));
      }

    });

    //监听选择  活动组织人员
    EventBus.on("notice.activity_organiser.onSubmit", function (evt) {
      if ($scope.$parent) {
        $scope.model.userName = "";
        $scope.model.organiserId = evt.data;

        angular.forEach(evt.data, function (item) {
          $scope.model.userName += item.uuiName + ","
        });

        $scope.model.userName = $scope.model.userName.substring(0, $scope.model.userName.length - 1);
        printLog("监听选择组织人员" + JSON.stringify($scope.model.organiserId));
      }

    });

    //上传图片
    $scope.uploadFiles = function (files, newFiles, duplicateFiles, invalidFiles, event) {

      console.log('uploadFiles');
       if (invalidFiles && invalidFiles.length) {
	      	zn.showToast("上传的图片尺寸不符合");
       }else{
	      if (files && files.length) {
	      	zn.showWaiting();
	        for (var i = 0; i < files.length; i++) {
	          Upload.upload({
	            url: API_imgbaseurl + '/api/file/imgUploadFile',
	            data: {
	              image: files[i]
	            }
	          }).then(function (response) {
	          	imgLength++;
	            if (response.data && response.data != '') {
	              $scope.model.imgUrl.push(response.data);
	              console.log(response.data);
	            }
	            if(imgLength == (files.length - 1)){
								zn.hideWaiting();
							}
	          }, function (resp) {
	            console.log('Error status: ' + resp.status);
	          }, function (evt) {
	            //console.log('progress:' + JSON.stringify(evt));
	          });
	        }
	      }
      }
    }

    //上传banner图片
    $scope.uploadBannerFiles = function (file, newFiles, duplicateFiles, invalidFiles, event) {
      console.log('uploadBannerFiles');

      if (invalidFiles && invalidFiles.length) {
	      	zn.showToast("上传的图片尺寸不符合");
       }else{
	      if (file && file.length) {
	      		zn.showWaiting();
	          Upload.upload({
	            url: API_imgbaseurl + '/api/file/imgUploadFile',
	            data: {
	              image: file[0]
	            }
	          }).then(function (response) {
	            if (response.data && response.data != '') {
	              $scope.model.bannerUrl=response.data;
	              console.log(response.data);
	              zn.hideWaiting();
	            }
	          }, function (resp) {
	            console.log('Error status: ' + resp.status);
	          }, function (evt) {
	            //console.log('progress:' + JSON.stringify(evt));
	          });
	      }
      }
    }

    //删除图片
    $scope.deleteImg = function (index) {
      $scope.model.imgUrl.splice(index, 1);
    }

    //删除banner图片
    $scope.deleteBannerImg = function () {
    	$scope.showBanner = false;
      $scope.model.bannerUrl="";
    }

    //跳转到地图
    $scope.toMap = function () {
      if ($scope.model.abiGpsLng && $scope.model.abiGpsLat)
        $scope.openWindow("baidumap", {lng: $scope.model.abiGpsLng, lat: $scope.model.abiGpsLat})
      else
        $scope.openWindow("baidumap")
    }

    //提交创建活动
    $scope.createActivity = function () {
      console.log("创建活动：" + JSON.stringify($scope.model));
//		$scope.addActivityId = 10000509;
//		$scope.showSubmitSuccess();

      //判断参数
      if ($scope.model.categoryId == undefined || $scope.model.categoryId.length == 0) {
        zn.showToast("活动类别不能为空")
        return;
      }
      if ($scope.model.abiName == "") {
        zn.showToast("活动名称不能为空")
        return;
      }
      if ($scope.model.sponsorId == undefined || $scope.model.sponsorId.length == 0) {
        zn.showToast("活动主办方不能为空")
        return;
      }
      if ($scope.model.organizerId == undefined || $scope.model.organizerId.length == 0) {
        zn.showToast("活动承办方不能为空")
        return;
      }
      if ($scope.model.abiPurpose == undefined || $scope.model.abiPurpose.length == 0) {
        zn.showToast("活动意义不能为空")
        return;
      }
      if ($scope.model.abiDescription == undefined || $scope.model.abiDescription.length == 0) {
        zn.showToast("活动简介不能为空")
        return;
      }
      if(!$scope.model.abiStartTime){
        zn.showToast("活动开始时间 不能为空")
        return;
      }
      if(!$scope.model.abiEndTime){
        zn.showToast("活动结束时间 不能为空")
        return;
      }
      if(!$scope.model.abiRegistrationDeadline){
        zn.showToast("活动截止时间 不能为空")
        return;
      }
      if ($scope.model.abiStartTime > $scope.model.abiEndTime) {
        zn.showToast("活动开始时间 不能晚于 结束时间")
        return;
      }
      if ($scope.model.abiRegistrationDeadline > $scope.model.abiEndTime) {
        zn.showToast("活动报名截止时间 不能晚于 结束时间")
        return;
      }
      if ($scope.model.abiGpsPlace == "") {
        zn.showToast("活动地点不能为空")
        return;
      }
      if($scope.model.abiGpsLng=="" && $scope.model.abiGpsLat==""){
      	zn.showToast("请选择地图上的地点")
        return;
      }
//    if ($scope.model.organiserId == undefined || $scope.model.organiserId.length == 0) {
//      zn.showToast("活动组织人员不能为空")
//      return;
//    }
      if ($scope.model.limitSignNum == undefined ||$scope.model.limitSignNum == "") {
        zn.showToast("请填写活动人数")
        return;
      }

      ajaxPost.call($scope, $http, API_appserverurl + "/api/activitybaseinfo/addData", {
        data: $scope.model
      }, "新增活动", function (ret) {
        $scope.addActivityId = ret;
        $scope.showSubmitSuccess();
      })
    }

    //继续发布
    $scope.release = function () {
      $scope.model = {
        abiCategory: "",
        abiSponsor: "",
        abiOrganizer: "",
        userName: "",
        imgUrl: [],
        abiGpsPlace: "",
        abiWeightDate: "",
        auditTime: "",
        budget: "",
        allowComment: 0,//默认公开评论
        abiSignOpen: 0,//默认公开报名
      }
    }

    var myPopup = null;
    //提交成功
    $scope.showSubmitSuccess = function () {
      myPopup = $ionicPopup.show({
        title: '',
        template: '<i ng-click="closeHonorPopup()" class="icon-common_prompt_cancel"></i>'
        + '<div class="submit-success-div">'
        + '<span class="icon-common_success_star_bg">'
        + '<span class="path1"></span><span class="path2"></span>'
        + '<span class="path3"></span><span class="path4">'
        + '</span><span class="path5"></span>'
        + '</span><br/><div class="desc">提交成功</div><div>',
        scope: $scope,
        buttons: [{
          text: '查看此活动 ',
          type: 'button',
          onTap: function (e) {
            $scope.release();
            myPopup.close();
            $scope.openWindow('activity_details', {id: $scope.addActivityId});
          }
        }, {
          text: '继续发布',
          type: 'button-positive',
          onTap: function (e) {
            $scope.release();
            myPopup.close();
          }
        }]
      });
    }

    //关闭成功弹出框
    $scope.closeHonorPopup = function () {
      myPopup.close();
    }

  }

</script>
