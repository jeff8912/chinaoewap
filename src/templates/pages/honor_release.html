<style>
	.bar-subheader {
		top: 44px;
		display: block;
		height: 44px;
		text-align: center;
		background-color: #39d0e7;
		color: #fff;
		height: 12px;
		font-size: 6px;
		line-height: 12px;
		position: absolute;
		padding: 0;
		top: 31px;
	}
</style>
<ion-view hide-nav-bar="true" hide-back-button="true" id="honor_release">
			<div class="bar-stable bar bar-header" align-title="center">
				<button class="button back-button buttons button-icon icon ion-ios-arrow-back header-item" ng-click="$parent.$ionicGoBack()" style="-webkit-transition-duration: 0ms; transition-duration: 0ms;">
					<span class="back-text" style="-webkit-transition-duration: 0ms; transition-duration: 0ms; -webkit-transform: translate3d(0px, 0px, 0px);"></span>
				</button>
				<div class="title title-center header-item" style="-webkit-transition-duration: 0ms; transition-duration: 0ms; -webkit-transform: translate3d(0px, 0px, 0px); left: 61px; right: 61px;">
					<span align-title="center" class="nav-bar-title">
						<div ng-click="openHonorModal()" class="honor-title">
							<span ng-if="!isHonorEdit">发布荣誉</span>
							<span ng-if="isHonorEdit">编辑荣誉</span>
							<div class="bar bar-subheader">
								<span ng-if="!isSubmit">查看结果</span>
								<span ng-if="isSubmit">提交审核</span>
								<span class="icon-topbar_arrow_down" ng-if="!showHonorModal"></span>
								<span class="icon-topbar_arrow_up" ng-if="showHonorModal"></span>
							</div>
						</div>
					</span>
				</div>
				<div class="buttons buttons-right" style="-webkit-transition-duration: 0ms; transition-duration: 0ms;">
					<a class="button button-blue btnsubmit" ng-href="" ng-click="submitHonor()" ng-bind="postModel.id?'重新提交':'提交'"></a>
				</div>
			</div>
	<!--<ion-nav-buttons side="right" ng-click="activitySearch()">
		<span class="release_submit" ng-click="submitHonor()">
			<span ng-if="postModel.id">重新提交</span>
			<span ng-if="!postModel.id">提交</span>
		</span>
	</ion-nav-buttons>
	<ion-nav-title align-title="center">
		<div ng-click="openHonorModal()">
			<span ng-if="!isHonorEdit">发布荣誉</span>
			<span ng-if="isHonorEdit">编辑荣誉</span>
			<div class="bar bar-subheader">
				<span ng-if="!isSubmit">查看结果</span>
				<span ng-if="isSubmit">提交审核</span>
				<span class="icon-topbar_arrow_down" ng-if="!showHonorModal"></span>
				<span class="icon-topbar_arrow_up" ng-if="showHonorModal"></span>
			</div>
		</div>
	</ion-nav-title>-->
	<div id="honorModal" ng-if="showHonorModal">
		<div class="item" ng-click="closeHonorModal(1)">
			<span>提交审核</span>
		</div>
		<div class="item" ng-click="gotoHonorListPage()">
			<span>查看结果</span>
		</div>
		<div class="opacity" ng-click="closeHonorModal()"></div>
	</div>
	<ion-content overflow-scroll="false" has-bouncing="true">
		<div class="list">
			<label class="item item-input reject-reason" ng-if="postModel.auditStatus == 1 && postModel.auditContent">
	    		<span>驳回理由：{{postModel.auditContent}}</span>
	  		</label>
			<label class="item item-input no-margin-bottom thin-border-left-16">
    			<span class="input-label">类别</span>
	    		<select ng-model="postModel.uhiLabel" 
	    			ng-options="option.id as option.sdiName for option in model.honorTypeList" ng-change="selectLabel(postModel.uhiLabel)">
			      	<!--<option ng-repeat="item in model.honorTypeList" value="{{item.id}}">{{item.sdiName}}</option>-->
			    </select>
			    <span class="icon-topbar_arrow_down" style="position: absolute; right: 16px; top: 18px; color: #39D0E7;"></span>
			    <!--<span class="pulldown-trigon"></span>-->
	  		</label>
			<label class="item item-input {{model.nameMargin}}" >
    			<span class="input-label">名称</span>
	    		<input type="text" placeholder="请输入名称" ng-model="postModel.uhiName">
	  		</label>
	  		<label class="item item-input" ng-if="model.selectLabelName == '证书' ||model.selectLabelName == '奖励'">
    			<span class="input-label">获取时间</span>
				<input type="date" ng-model="postModel.uhiDateStart"/>
	  		</label>
			<label class="item item-input thin-border-left-16 no-margin-bottom" ng-if="model.selectLabelName == '校内职务'">
    			<span class="input-label">开始时间</span>
				<input type="date" ng-model="postModel.uhiDateStart"/>
	  		</label>
			<label class="item item-input" ng-if="model.selectLabelName == '校内职务'">
    			<span class="input-label">结束时间</span>
				<input type="date" ng-model="postModel.uhiDateEnd"/>
	  		</label>
			<label class="item item-input item-stacked-label item-textarea">
	  			<span class="input-label margin-bottom-6">介绍</span>
			    <textarea placeholder="介绍" rows="6" ng-model="postModel.uhiDescription" maxlength="2500" autocomplete="off" autocorrect="off"></textarea>
			    <p class="float-right textarea-sub">{{postModel.uhiDescription.length || 0}}/2500</p>
			</label>
			<div class="item item-input upload-label">
				<span class="input-label">上传荣誉图片（不限制）</span>
			</div>
			<div class="item item-input marginTop marginBottom multiple-label row">
				<!--<span>最多上传6张</span><br/>-->
				<div class="multiple-div col-33" ng-repeat="file in postModel.imgUrl">
					<div class="img-span">
						<img ng-src="{{file | formatDbImgUrl}}" />
						<span class="icon-common_prompt_cancel" ng-click="deleteImg($index)"></span>
					</div>
				</div>
				<div class="multiple-div col-33">
					<span class="icon-create_add_photo col-33" ngf-multiple="true" ngf-change="uploadFiles($files)" ngf-accept="'image/*'" ngf-fix-orientation="true" ngf-capture="'camera'" ngf-drop ngf-select ngf-resize="{width: 720, quality: 0.8, type: 'image/jpeg'}" ngf-resize-if="$width > 720 || $height > 1280"> 
		  				<span class="path1"></span><span class="path2"></span><span class="path3"></span>
					</span>
	  			</div>
			</div>
			<!--<div class="item re-release">
				<button class="button button-small button-calm" ng-click="submitHonor()">
				  	<span ng-if="">重新</span>提交
				</button>
				<button class="button button-small button-calm" ng-click="cancel()">
				  	取消
				</button>
			</div>-->
		</div>
	</ion-content>
</ion-view>
<script type="text/javascript">
	var filesInt = 0;
	function pageCtrl($scope, $http, $rootScope, $ionicHistory, $timeout, $ionicModal, $ionicPopup, EventBus, $ionicPopover, Upload, $ionicLoading) {
		var params = $scope.pageParams();
		$scope.model = {
			selectLabelName: '',
			nameMargin: ''
		};
		$scope.postModel = {
			imgUrl: [],
			auditStatus: 0
		};
		//上传图片
		$scope.uploadFiles = function(files) {
			console.log('uploadFiles');
			if (files && files.length) {
				zn.showWaiting();
				filesInt = 0;
				for (var i = 0; i < files.length; i++) {
					Upload.upload({
						url: API_imgbaseurl + '/api/file/imgUploadFile',
						data: {
							image: files[i]
						}
					}).then(function(response) {
						if (response.data && response.data != '') {
							$scope.postModel.imgUrl.push(response.data);
							console.log(response.data);
						}
						filesInt++;
						if(filesInt == (files.length - 1)){
							zn.hideWaiting();
						}
					}, function(resp) {
						console.log('Error status: ' + resp.status);
						filesInt++;
						if(filesInt == (files.length - 1)){
							zn.hideWaiting();
						}
					}, function(evt) {
						//console.log('progress:' + JSON.stringify(evt));
					});
				}
			}
		}
		//选择荣誉类别
		$scope.selectLabel = function(id) {
			if(id == 0)
				$scope.model.nameMargin = "";
			else
				$scope.model.nameMargin = "thin-border-left-16 no-margin-bottom";
			angular.forEach($scope.model.honorTypeList, function(value, key){
				if(value.id == id){
					$scope.model.selectLabelName = value.sdiName;					
				}
			});
			
			console.log(JSON.stringify($scope.model.selectLabelName) + "荣誉类别");
		}
		//删除图片
		$scope.deleteImg = function(index) {
			$scope.postModel.imgUrl.splice(index, 1);
		}
		//获取全部荣誉类别
		$scope.model.honorTypeList = [{
			id: "0",
			sdiName: "请选择荣誉类别"
		}];
		$scope.getHonorType = function(index) {
			ajaxPost.call(
				$scope, $http,
				API_appserverurl + '/api/sysdictionaryinfo/getDictList', {
					scdId: honorCategory
				},
				'获取全部荣誉类别',
				function(data) {
					$timeout(function() {
						if (data && data.length > 0) {
							angular.forEach(data, function(value, key) {
								$scope.model.honorTypeList.push(value);
							});
						}
						console.log(JSON.stringify($scope.model.honorTypeList) + $scope.model.honorTypeList.length);
						$scope.postModel.uhiLabel = $scope.model.honorTypeList[0].id;
					});
				},
				function(error) {
					$scope.postModel.uhiLabel = $scope.model.honorTypeList[0].id;
				});
		}
		if (params && params.id) {
			$scope.isSubmit = true;
		}
		$scope.getHonorType();
		//提交荣誉
		$scope.submitHonor = function() {
			if ($scope.postModel.uhiLabel <= 0) {
				showError("请选择荣誉类别");
				return;
			}
			if (!$scope.postModel.uhiName) {
				showError("请填写荣誉名称");
				return;
			}
			if (!$scope.postModel.uhiDateStart) {
				showError("请选择开始时间");
				return;
			}
			if (!$scope.postModel.uhiDateEnd && model.selectLabelName == '校内职务') {
				showError("请选择结束时间");
				return;
			}
			if ($scope.postModel.imgUrl.length <= 0) {
				showError("请添加图片");
				return;
			}
			var url = "";
			if (params.id) {
				url = '/api/userhonorinfo/editData';
			} else {
				url = '/api/userhonorinfo/addData';
			}
			console.log(JSON.stringify($scope.postModel));
			ajaxPost.call(
				$scope, $http,
				API_appserverurl + url,
				$scope.postModel,
				'提交荣誉',
				function(data) {
					console.log("提交成功" + JSON.stringify(data));
					$scope.showSubmitSuccess(data.id);
				},
				function(error) {
					//TODO
				});
		}
		//提交成功
		var myPopup = null;
		$scope.showSubmitSuccess = function(id) {
			myPopup = $ionicPopup.show({
				title: '',
				template: '<i ng-click="closeHonorPopup()" class="icon-common_prompt_cancel"></i>'
					+'<div class="submit-success-div">'
					+'<span class="icon-common_success_star_bg">'
                	+'<span class="path1"></span><span class="path2"></span>'
                	+'<span class="path3"></span><span class="path4">'
                	+'</span><span class="path5"></span>'
                	+'</span><br/><div class="desc">提交成功</div><div>',
				scope: $scope,
				buttons: [{
					text: '查看此荣誉',
					type: '',
					onTap: function(e) {
						if(!params.id){
							$scope.resetModel();							
						}
						$scope.openWindow('honor_detail', {id: id});
					}
				}, {
					text: '继续发布',
					type: 'button-positive',
					onTap: function(e) {
						$scope.resetModel();
						myPopup.close();
					}
				}]
			});
		}
		//关闭成功弹出框
		$scope.closeHonorPopup = function() {
			if(!params.id){
				$scope.resetModel();							
			}
			myPopup.close();
		}
		//重置数据
		$scope.resetModel = function () {
			$scope.postModel = {
				imgUrl: [],
				auditStatus: 0
			};
			$scope.postModel.uhiLabel = $scope.model.honorTypeList[0].id;
		}
		//获取荣誉详情
		$scope.getHonor = function() {
			$scope.$parent.isSubmit = true;
			if (params.id) {
				$scope.isHonorEdit = true;
				ajaxPost.call(
					$scope, $http,
					API_appserverurl + '/api/userhonorinfo/getHonor', {
						id: params.id
					},
					'获取荣誉详情',
					function(data) {
						$timeout(function() {
							$scope.postModel.id = data.id;
							$scope.postModel.uhiName = data.uhiName;
							$scope.postModel.uhiDateStart = data.uhiDateStart;
							$scope.postModel.uhiDateEnd = data.uhiDateEnd;
							$scope.postModel.uhiDescription = data.uhiDescription;
							$scope.postModel.auditStatus = data.auditStatus;

							if (data.imgUrl) {
								$scope.postModel.imgUrl = data.imgUrl.split(",");
							}
							$scope.postModel.uhiLabel = data.uhiLabelModel.id;
							console.log(JSON.stringify(data) + "荣誉");
						});
					},
					function(error) {
						//TODO
					});
			}
		}
		$scope.getHonor();
		$scope.closeHonorModal = function(isSubmit) {
			if(isSubmit){
				$scope.isSubmit = true;
			}
			$scope.$parent.showHonorModal = false;
		}
		$scope.gotoHonorListPage = function () {
			$scope.$parent.showHonorModal = false;
			$scope.isSubmit = false;
			$scope.openWindow('honor_list')			
		}
	}
</script>