<ion-view hide-back-button="false" id="my_expense">
	<ion-nav-title align-title="center">
		<!--我的报销-列表-->
		<span class="ui inverted header">我的报销</span>
	</ion-nav-title>
	<div class="tabs tabs-default tabs-top">
		<a ng-repeat="item in model.statusList" ng-click="selectByStatus($index)" class="tab-item {{item.cls}}">
	    	{{item.label}}
	  	</a>
	</div>
	<ion-content overflow-scroll="false" has-bouncing="true">
		<ion-refresher pulling-text="下拉刷新" on-refresh="pulldownRefresher()"></ion-refresher>
		<div class="list">
			<ion-list show-delete="shouldShowDelete">
				<ion-item class="item item-thumbnail-left" ng-repeat="item in model.expenseList">
					<img image-lazy-src="{{item.expenses.img_url | formatDbImgUrl}}" 
						 image-lazy-distance-from-bottom-to-load="100"
						 ng-click="clickLook(item.id, item.abiId.id)">
					<h2 ng-click="clickLook(item.id, item.abiId.id)">{{item.expenses.abi_name}}</h2>
					<!--<p><span class="step size-16"><i class="icon ion-android-time"></i></span>活动时间：2016/03/01 18:00-20:00</p>-->
					<p><span class="icon-my_news_add"></span>&nbsp;活动地点：{{item.expenses.abi_gps_place}}</p>
					<p><span class="icon-my_news_number"></span>&nbsp;活动人数：{{item.expenses.abi_sign_num?item.expenses.abi_sign_num:"不限"}}</p>
					<p><span class="icon-my_activity_wiped"></span>&nbsp;活动经费：{{item.aeiAmount}}
					   <span class="float-right" style="color: #9B9B9B;">{{item.createDate | formatDate}}</span>
						<!--<a ng-click="clickLook(item.id)" class="float-right click-look" ng-if="model.selectStatus==0 || model.selectStatus==2" href="javascript:void(0);">点击查看</a>-->
						<!--<a class="cancel" ng-click="cancelRelaase(item.id)" class="float-right click-look" ng-if="model.selectStatus==1" href="javascript:void(0);">取消报销</a><br />-->
					</p>
					<ion-option-button ng-if="model.selectStatus == 1" class="button-assertive" ng-click="cancelRelaase(item.id)">
						取消报销
					</ion-option-button>
				</ion-item>
			</ion-list>
		</div>
		<div class="nodata_textdiv" ng-if="model.hasData==0">
			童鞋，你还木有报销信息哟~~！
		</div>
		<ion-infinite-scroll ng-if="model.isMore" on-infinite="loadMore()" distance="1%"></ion-infinite-scroll>
	</ion-content>
</ion-view>
<script type="text/javascript">
	function pageCtrl($scope, $http, $rootScope, $ionicHistory, $timeout, $ionicModal, $ionicPopup, EventBus, $ionicPopover, Upload, $ionicLoading) {
		$scope.model = {
				limit: 10,
				page: 1,
				hasData: 1,
				expenseList: [],
				selectStatus: 0,
				isMore: false,
				statusList: [{
					label: '待审核',
					cls: 'active'
				}, {
					label: '未通过',
					cls: ''
				}, {
					label: '已通过',
					cls: ''
				}]
			}
			//状态切换
		$scope.selectByStatus = function(index) {
				angular.forEach($scope.model.statusList, function function_name(item, key) {
					item.cls = '';
				});
				$scope.model.statusList[index].cls = 'active';
				$scope.model.selectStatus = index;
				$scope.model.page = 1;
				$scope.getExpenseData();
			}
			//获取新闻稿列表
		$scope.getExpenseData = function() {
			ajaxPost.call(
				$scope, $http,
				API_appserverurl + '/api/activityexpensesinfo/getExpenseList', {
					limit: $scope.model.limit,
					skip: ($scope.model.page - 1) * $scope.model.limit,
					status: $scope.model.selectStatus
				},
				'获取报销列表',
				function(data) {
					//console.log("#############" + JSON.stringify(data) + "---end");
					$timeout(function() {
						//console.log(data.totalCnt + "----------" + $scope.model.page * $scope.model.limit + "-----" + $scope.model.isMore);
						// console.log(data.queryData.length + "    多少条！！！");
						if (data && data.queryData && data.queryData.length > 0) {
							if ($scope.model.page == 1)
								$scope.model.expenseList = [];
							angular.forEach(data.queryData, function(value, key) {
								$scope.model.expenseList.push(value);
							});
							if (data.totalCnt > ($scope.model.page * $scope.model.limit)) {
								$scope.model.isMore = true;
							} else {
								$scope.model.isMore = false;
							}
							$scope.model.hasData = 1;
						} else {
							if ($scope.model.page == 1) {
								$scope.model.expenseList = [];
								$scope.model.hasData = 0;
							}
							$scope.model.isMore = false;
						}
					});
				},
				function(error) {
					//TODO
				});
		}
		$scope.getExpenseData();
		//下拉刷新
		$scope.pulldownRefresher = function() {
			$scope.model.page = 1;
			$scope.getExpenseData();
			$scope.$broadcast('scroll.refreshComplete');
		};
		//上拉加载更多
		$scope.loadMore = function() {
				$scope.getExpenseData($scope.model.page++);
				$scope.$broadcast('scroll.infiniteScrollComplete');
			}
			//点击查看
		$scope.clickLook = function(id, abiId) {
				console.log("id..........." + id);
				if ($scope.model.selectStatus == 2) {
					$scope.openWindow('expense_info', {
						id: id
					});
				} else if ($scope.model.selectStatus == 0 || $scope.model.selectStatus == 1) {
					$scope.openWindow('expense_edit', {
						aeiId: id,
					});
				}
			}
			//取消报销
		$scope.cancelRelaase = function(id) {
			var confirmPopup = $ionicPopup.confirm({
		        title: '删除',
		        template: '确认取消报销？',
		        buttons: [{
					text: '<b>确定</b>',
					type: 'button',
					onTap: function(e) {
						ajaxPost.call(
							$scope, $http,
							API_appserverurl + '/api/activityexpensesinfo/hideData', {
								id: id,
							},
							'取消申请报销',
							function(data) {
								showSuccess("取消申请报销成功");
								$scope.openWindow('my_expense');
								$scope.model.page = 1;
								$scope.getExpenseData();
							},
							function(error) {
								//TODO
							});
					}
				}, {
					text: '<b>取消</b>',
					type: 'button-positive',
					onTap: function(e) {
						confirmPopup.close();
					}
				}]
		    });
		}
	}
</script>