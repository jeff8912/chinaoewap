<ion-view hide-back-button="false" id="news_list">
	<ion-nav-title align-title="center">
		<span class="ui inverted header">我的新闻稿</span>
	</ion-nav-title>
	<div class="tabs tabs-default tabs-top">
		<a ng-repeat="item in model.statusList" ng-click="selectByStatus($index)" class="tab-item {{item.cls}}">
	    	{{item.label}}
	  	</a>
	</div>
	<ion-content lazy-scroll overflow-scroll="false" has-bouncing="true">
		<ion-refresher pulling-text="下拉刷新" on-refresh="pulldownRefresher()"></ion-refresher>
		<ion-list  show-delete="shouldShowDelete">
        	<ion-item class="item item-thumbnail-left" ng-repeat="item in model.newsList">
        		<img image-lazy-src="{{item.aniImgUrl | formatDbImgUrl}}" 
        			 image-lazy-distance-from-bottom-to-load="100"
        		     ng-click="clickLook(item.id, item.abiId.id)">
				<h2 ng-click="clickLook(item.id, item.abiId.id)"><a href="javascript:void(0)">{{item.aniTitle}}</a></h2>
				<p><span class="icon-my_news_add"></span>&nbsp;活动地点：{{item.news.abi_gps_place}}</p>
				<p>
					<span class="icon-my_news_time"></span>&nbsp;活动时间：<a href="javascript:void(0)">{{item.news | dateregion}}</a>
				</p>
				<p class="ellipsis">
					<span class="icon-my_news_number"></span>&nbsp;活动人数：{{item.news.abi_sign_num}}
					<span class="float-right" style="color: #9B9B9B;">{{item.createDate | formatDate}}</span>
					<!--<a ng-click="clickLook(item.id)" class="float-right click-look" ng-if="model.selectStatus==0 || model.selectStatus==2" href="javascript:void(0);">点击查看</a>
					<a ng-click="cancelRelaase(item.id)" class="float-right click-look" ng-if="model.selectStatus==1" href="javascript:void(0);">取消发布</a>-->
				</p>
        		<ion-option-button ng-if="model.selectStatus == 1" class="button-assertive" ng-click="cancelRelaase(item.id)">
	      			取消发布
	    		</ion-option-button>
	        </ion-item>
      	</ion-list>
		<!--<div class="list">
			<div class="item item-thumbnail-left" ng-repeat="item in model.newsList" ng-click="clickLook(item.id, item.abiId.id)">
				<img src="{{formatNewsImgUrl(item.aniImgUrl)}}">
				<h2>{{item.aniTitle}}</h2>
				<p><span class="icon-my_news_add"></span>&nbsp;活动地点：{{item.news.abi_gps_place}}</p>
				<p><span class="icon-my_news_time"></span>&nbsp;活动时间：{{item.news.abi_start_time}} -- {{item.news.abi_end_time}}</p>
				<p>
					<span class="icon-my_news_number"></span>&nbsp;活动人数：{{item.news.abi_sign_num}}
					<a ng-click="clickLook(item.id)" class="float-right click-look" ng-if="model.selectStatus==0 || model.selectStatus==2" href="javascript:void(0);">点击查看</a>
					<a ng-click="cancelRelaase(item.id)" class="float-right click-look" ng-if="model.selectStatus==1" href="javascript:void(0);">取消发布</a>
				</p>
			</div>
		</div>-->
		<div class="nodata_textdiv" ng-if="model.hasData==0">
	       	童鞋，你还木有该类信息哟~~！
	    </div>
		<ion-infinite-scroll ng-if="model.isMore" on-infinite="loadMore()" distance="1%"></ion-infinite-scroll>
	</ion-content>
</ion-view>
<script type="text/javascript">
	function pageCtrl($scope, $http, $rootScope, $ionicHistory, $timeout, $ionicModal, $ionicPopup, EventBus, $ionicPopover, Upload, $ionicLoading) {
		$scope.model = {
			limit: 5,
			page: 1,
			hasData: 1,
			newsList: [],
			selectStatus: 0,
			isMore: false,
			statusList: [{
				label: '待审核',
				cls: 'active'
			}, {
				label: '未通过',
				cls: ''
			}, {
				label: '已通过',
				cls: ''
			}]
		}
		//状态切换
		$scope.selectByStatus = function(index) {
			angular.forEach($scope.model.statusList, function function_name(item, key) {
				item.cls = '';
			});
			$scope.model.statusList[index].cls = 'active';
			$scope.model.selectStatus = index;
			$scope.model.page = 1;
			$scope.getNewsData();
			$scope.$parent.scrollTop();
		}

		//获取新闻稿列表
		$scope.getNewsData = function() {
			ajaxPost.call(
				$scope, $http,
				API_appserverurl + '/api/activitynewsinfo/getNewsList', {
					//					uuiId: uuiId,
					limit: $scope.model.limit,
					offset: ($scope.model.page - 1) * $scope.model.limit,
					status: $scope.model.selectStatus,
					uuiId: 1
				},
				'获取新闻稿列表',
				function(data) {
					$timeout(function() {
						$timeout(function() {
							console.log(data.totalCnt + "----------" + $scope.model.page * $scope.model.limit + "-----" + $scope.model.isMore);
							if (data && data.queryData && data.queryData.length > 0) {
								if ($scope.model.page == 1)
									$scope.model.newsList = [];
								angular.forEach(data.queryData, function(value, key) {
									$scope.model.newsList.push(value);
								});
								if (data.totalCnt > ($scope.model.page * $scope.model.limit)) {
									$scope.model.isMore = true;
								} else {
									$scope.model.isMore = false;
								}
								$scope.model.hasData = 1;
							} else {
								if ($scope.model.page == 1){
									$scope.model.newsList = [];
									$scope.model.hasData = 0;
								}
								$scope.model.isMore = false;
							}
						});
					});
				},
				function(error) {
					//TODO
				});
		}
		$scope.getNewsData();
		//下拉刷新
		$scope.pulldownRefresher = function() {
			$scope.model.page = 1;
			$scope.getNewsData();
			$scope.$broadcast('scroll.refreshComplete');
		};
		//上拉加载更多
		$scope.loadMore = function() {
			$scope.getNewsData($scope.model.page++);
			$scope.$broadcast('scroll.infiniteScrollComplete');
		}
		//点击查看
		$scope.clickLook = function(id, abiId) {
			console.log("id..........." + id + "活动ID" + abiId);
			if ($scope.model.selectStatus == 2) {
				$scope.openWindow('news_detail', {
					id: id
				});
			} else if($scope.model.selectStatus == 0 || $scope.model.selectStatus == 1){
				$scope.$parent.isSubmit = true;
				$scope.openWindow('news_release', {
					id: id,
					abiId: abiId
				});
			}
		}
		//取消发布
		$scope.cancelRelaase = function(id) {
			var confirmPopup = $ionicPopup.confirm({
		        title: '删除',
		        template: '确定取消发布你的的新闻稿？',
		        buttons: [{text: "取消"}, {
		          	text: '<b>确定</b>',
		          	type: 'button-positive',
		          	onTap: function (e) {
			            ajaxPost.call(
							$scope, $http,
							API_appserverurl + '/api/activitynewsinfo/hideData', {
								id: id,
							},
							'取消发布新闻稿',
							function(data) {
								$scope.model.page = 1;
								$scope.getNewsData();
								showSuccess("取消发布成功");
							},
							function(error) {
								//TODO
							});
			            confirmPopup.close();
			            e.preventDefault();
		          }
		        }]
		    });
		}
	}
</script>