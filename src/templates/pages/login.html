<ion-view hide-back-button="true" hide-nav-bar="true" id="login">

  <ion-content lazy-scroll scroll="false" has-bouncing="false" class="no-footer" style="background-color: #fff;">
    <div class="login login_pane" ng-class="{'blurPixel':showSlide}">
      <form ng-submit="checkLogin()">

        <div ng-class="{'clkcheckform':clkcheckform}" style="position: relative;z-index: 9;">
          <div class="login_logo">
            <div class="login_logo_imgbg"></div>
          </div>
          <div class="row padding-bottom">
            <div class="col text-center">
              <input class="text-center login_input border-top border-bottom" type="text" placeholder="用户手机号/身份证/邮箱"
                     ng-model="model.loginName" style="overflow-y: hidden;"
                     maxlength="100" ng-minlength="5" ng-maxlength="100" ng-required="true" tabindex="1">
            </div>
          </div>
          <div class="row padding-bottom">
            <div class="col text-center">
              <input class="text-center login_input border-top border-bottom" type="password" placeholder="请输入密码"
                     style="overflow-y: hidden;"
                     ng-model="model.password" maxlength="12" ng-minlength="8" ng-maxlength="12" ng-required="true"
                     tabindex="2">
            </div>
          </div>
          <div class="row padding-bottom">
            <div class="col text-center">
              <button type="submit" class="button button-blue login_btn" ng-click="checkLogin()">登录</button>
            </div>
          </div>
          <div class="row padding-bottom">
            <div class="col" style="text-align: right;">
              <button type="button" ng-click="gotoForgetPwd()"
                      class="button button-light login_txtcls1 padding-right button-clear">忘记密码
              </button><span
              class="padding-left"
              style="width:1px; height: 12px; display: block; border-right: 1px solid #9494A2; float:right;margin-top: 4px;"></span>
            </div>
            <div class="col padding-left" style="text-align: left;">
              <button type="button" ng-click="gotoUserRegister()"
                      class="button button-light login_txtcls1 padding-left button-clear">注册账号
              </button>
            </div>
          </div>
        </div>
        <div class="login_bottom_gif"></div>
      </form>
    </div>
    <div ng-if="showSlide" style="position: absolute; top:0; left: 0; z-index: 9; width:100%; height: 100%; background-color: #000; opacity: 0.7;"></div>
    <ion-slide-box class="login_slide" show-pager="true" ng-if="showSlide" style="position: absolute; top:0; left: 0; z-index: 9; width:100%; height: 100%;" on-slide-changed="slideHasChanged($index)">
      <ion-slide>
        <div style="height: 100%; background:url('./img/appslide1.png') no-repeat center center;background-size: cover;"></div>
      </ion-slide>
      <ion-slide>
        <div style="height: 100%; background:url('./img/appslide2.png') no-repeat center center;background-size: cover;"></div>
      </ion-slide>
      <ion-slide>
        <div style="height: 100%; background:url('./img/appslide3.png') no-repeat center center;background-size: cover;"></div>
      </ion-slide>
      <ion-slide>
        <div style="height: 100%; background:url('./img/appslide4.png') no-repeat center center;background-size: cover;" ng-click="hideSlideImg()"></div>

        <div class="login_slide_btnenter" ng-click="hideSlideImg()">立即进入</div>
      </ion-slide>
    </ion-slide-box>
  </ion-content>
</ion-view>
<script type="text/javascript">
  function pageCtrl($scope, $http, $rootScope, $ionicHistory, $timeout, $ionicModal, $ionicPopup, EventBus, $ionicPopover, Upload, $ionicLoading) {
    $scope.model = {};

    $scope.getLoadData = function () {
//      db.del('app_no_first_load');
      console.log("zn.isDevice() > " + zn.isDevice());

      if(window.cordova && window.cordova.plugins.Keyboard) 
    		cordova.plugins.Keyboard.disableScroll(false);
	  if (window.StatusBar)
    		StatusBar.styleDefault();
                		
      db.get('app_no_first_load', function (loaded) {
        console.log("loaded > " + loaded);
        if(loaded) {
          db.get('login_model', function (dbmodel) {
            console.log('kkkkkkk:' + JSON.stringify(dbmodel));
            if (_.isObject(dbmodel) && _.isString(dbmodel.loginName)) {
              $scope.model = dbmodel;
              $scope.loginData();
            }
          });
        }else{
          db.add('app_no_first_load', true);
          $scope.showSlide = true;
        }
      });

    }
    $scope.hideSlideImg = function () {
      $scope.showSlide = false;
    }
    $scope.slideHasChanged = function (idx) {
      if(idx == 3){
        if(!$scope.showHideSlide) {
          $scope.showHideSlide = true;
          $timeout(function () {
            $('div.login_slide_btnenter').transition({animation: 'fade', duration: 5000});
          }, 500);
        }
        angular.element('div.slider-pager').hide();
      }else{
        angular.element('div.slider-pager').show();
      }
    }

    $scope.loginData = function () {
      if (_.isString($scope.model.loginName)) {
        var _isIO = isAjaxToIO;
        // 强制用Ajax：
        isAjaxToIO = false;
        ajaxPost.call($scope, $http, API_appserverurl + "/api/user/loginData", $scope.model, "登录",
          function (ret) {
            islogined = true;
            $scope.$parent.removeUrlCache();
            db.add('login_model', $scope.model);
            $scope.$parent.setTagsWithAlias(ret);

            uuiId = ret.id;
            isAjaxToIO = true;

			if(window.cordova && window.cordova.plugins.Keyboard) 
        			cordova.plugins.Keyboard.disableScroll(true);
    		    if (window.StatusBar)
        			StatusBar.styleLightContent();
                		
            $scope.openWindow('home');
          });
        isAjaxToIO = _isIO;
      }
    }

    $scope.checkLogin = function () {
      $scope.clkcheckform = true;
      var errinfo = '';
      if (!_.isString($scope.model.loginName) || $scope.model.loginName == '' || !CheckPhoneFormat($scope.model.loginName) && !IdentityCodeValid($scope.model.loginName) && !EmailValid($scope.model.loginName)) {
        errinfo += ',登录用户名不能为空,且格式必须正确';
      }
      if (!_.isString($scope.model.password) || $scope.model.password == null || $scope.model.password == '' || $scope.model.password.length < 8) {
        errinfo += ',密码不能为空且长度在8到12位';
      }
      if (errinfo == '') {
        $scope.loginData();
      } else {
        showError(errinfo.substring(1));
      }
      return false;
    }

    $scope.gotoForgetPwd = function () {
      return $scope.openWindow('user_password', {loginName: $scope.model.loginName && CheckPhoneFormat($scope.model.loginName) ? $scope.model.loginName : ''});
    }

    $scope.gotoUserRegister = function () {
      return $scope.openWindow('user_registerbyurl');
    }

    $scope.$parent.hideNavFooterBar = true;

    if (zn.isDevice()) {
      if (zn.deviceready) {
        $scope.getLoadData();
      } else {
        document.addEventListener("deviceready", function onDeviceReady() {
          //$timeout(function () {
          $scope.getLoadData();
          //},200);
        });
      }
    } else {
      $scope.getLoadData();
    }

  }

</script>
